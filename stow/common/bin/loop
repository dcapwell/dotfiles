#!/bin/bash
# Run a command repeatedly until it fails
# Usage: loop [--sleep N] command [args...]

sleep_sec=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --sleep)
      sleep_sec="$2"
      shift 2
      ;;
    -h|--help)
      echo "Usage: loop [--sleep N] command [args...]"
      echo "Run command repeatedly until it fails"
      echo ""
      echo "Options:"
      echo "  --sleep N  Sleep N seconds between iterations"
      exit 0
      ;;
    *)
      break
      ;;
  esac
done

if [[ $# -eq 0 ]]; then
  echo "Error: no command specified" >&2
  echo "Usage: loop [--sleep N] command [args...]" >&2
  exit 1
fi

count=1
while "$@"; do
  count=$((count + 1))
  sleep "$sleep_sec"
done

echo "Failed at iteration $count" >&2
exit 1
